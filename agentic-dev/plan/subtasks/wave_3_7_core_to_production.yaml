# Atomic Subtask Definitions - Wave 3-7 (Core Features to Production)
# Dependencies cascade from earlier waves

subtasks:
  # === WAVE 3: TASK-RES-001, TASK-HIE-003, TASK-TEST-001 ===
  
  # TASK-RES-001: Implement base resonator network structure
  - id: SUB-RES-001-A
    parent: TASK-RES-001
    title: Create src/resonator.rs module
    agent: RustEngineer
    status: completed
    deps: [TASK-VSA-001, TASK-VSA-003]
    scope: |
      Create new module src/resonator.rs:
      - Add mod resonator to lib.rs
      - Define Resonator struct with codebook reference
      - Add fields: max_iterations (default 10), convergence_threshold (default 0.001)
    files: [src/resonator.rs, src/lib.rs]
    acceptance:
      - Module compiles
      - Resonator struct is public
    estimate_minutes: 30
    
  - id: SUB-RES-001-B
    parent: TASK-RES-001
    title: Implement codebook projection
    agent: RustEngineer
    status: completed
    deps: [SUB-RES-001-A]
    scope: |
      Add to impl Resonator:
      - fn project(&self, noisy: &SparseVec) -> SparseVec
      - Compute cosine similarity against all codebook entries
      - Return entry with highest similarity
      - Handle ties by selecting first match
    file: src/resonator.rs
    acceptance:
      - Projection returns valid SparseVec
      - Correct entry selected for clean input
    estimate_minutes: 45
    
  - id: SUB-RES-001-C
    parent: TASK-RES-001
    title: Implement iterative refinement loop
    agent: RustEngineer
    status: completed
    deps: [SUB-RES-001-B]
    scope: |
      Add to impl Resonator:
      - fn factorize(&self, compound: &SparseVec, num_factors: usize) -> Vec<SparseVec>
      - Initialize factor estimates randomly
      - Loop: unbind other factors, project onto codebook, update estimate
      - Track convergence delta
      - Stop when delta < threshold or max iterations
    file: src/resonator.rs
    acceptance:
      - Factorizes 2-factor compound correctly
      - Converges within max_iterations
    estimate_minutes: 90
    
  - id: SUB-RES-001-D
    parent: TASK-RES-001
    title: Add convergence metrics
    agent: RustEngineer
    status: completed
    deps: [SUB-RES-001-C]
    scope: |
      Add convergence tracking:
      - Return FactorizeResult { factors: Vec<SparseVec>, iterations: usize, final_delta: f64 }
      - Log iteration progress if debug enabled
      - Return early if all factors stable
    file: src/resonator.rs
    acceptance:
      - Metrics are accurate
      - Early stopping works
    estimate_minutes: 30

  # TASK-HIE-003: Implement multi-level bundling
  - id: SUB-HIE-003-A
    parent: TASK-HIE-003
    title: Add path role binding with permutation
    agent: RustEngineer
    deps: [TASK-HIE-002, TASK-VSA-002]
    scope: |
      Implement path encoding:
      - Generate role vector for each path component
      - Bind path_role ⊙ content
      - Apply permutation for depth tagging
      - Bundle sibling entries
    file: src/embrfs.rs
    acceptance:
      - Path encoding is deterministic
      - Different paths produce orthogonal vectors
    estimate_minutes: 60
    
  - id: SUB-HIE-003-B
    parent: TASK-HIE-003
    title: Implement level-by-level bundling
    agent: RustEngineer
    deps: [SUB-HIE-003-A]
    scope: |
      Add multi-level encoding:
      - Level 0: File chunks (≤1000 per directory)
      - Level 1: Directory sub-engrams (≤1000 per parent)
      - Level 2+: Recursive bundling
      - Apply thinning after each bundle
    file: src/embrfs.rs
    acceptance:
      - 3+ level hierarchy encodes correctly
      - No bundle exceeds 1000 items
    estimate_minutes: 90
    
  - id: SUB-HIE-003-C
    parent: TASK-HIE-003
    title: Add TB-scale synthetic test
    agent: RustEngineer
    deps: [SUB-HIE-003-B]
    scope: |
      Create test for large-scale encoding:
      - Generate synthetic directory tree (10,000+ files)
      - Encode with hierarchical mode
      - Verify manifest structure
      - Measure encoding time
    file: tests/e2e_hierarchical.rs
    acceptance:
      - Test completes in reasonable time
      - Structure is correct
    estimate_minutes: 60

  # TASK-TEST-001: Property-based tests for VSA invariants
  - id: SUB-TEST-001-A
    parent: TASK-TEST-001
    title: Add proptest dependency
    agent: Tester
    deps: [TASK-VSA-001, TASK-VSA-002, TASK-VSA-003]
    scope: |
      Modify Cargo.toml:
      - Add proptest = "1.4" to dev-dependencies
      - Create tests/properties.rs
    files: [Cargo.toml, tests/properties.rs]
    acceptance:
      - cargo test compiles
      - proptest imported
    estimate_minutes: 15
    
  - id: SUB-TEST-001-B
    parent: TASK-TEST-001
    title: Implement bundle property tests
    agent: Tester
    deps: [SUB-TEST-001-A]
    scope: |
      Add proptest cases:
      - bundle_is_commutative: a ⊕ b ≈ b ⊕ a
      - bundle_is_associative: (a ⊕ b) ⊕ c ≈ a ⊕ (b ⊕ c)
      - bundle_preserves_similarity: sim(a, a⊕b) > threshold
    file: tests/properties.rs
    acceptance:
      - 1000+ cases pass
      - No counter-examples
    estimate_minutes: 45
    
  - id: SUB-TEST-001-C
    parent: TASK-TEST-001
    title: Implement bind property tests
    agent: Tester
    deps: [SUB-TEST-001-A]
    scope: |
      Add proptest cases:
      - bind_self_inverse: sim(a ⊙ a, identity) > threshold OR density check
      - bind_distributes_over_bundle: a ⊙ (b ⊕ c) ≈ (a ⊙ b) ⊕ (a ⊙ c)
      - unbind_recovers: sim((a⊙b) ⊙ b, a) > threshold
    file: tests/properties.rs
    acceptance:
      - 1000+ cases pass
    estimate_minutes: 45

  # === WAVE 4-5: TASK-RES-002, TASK-RES-003 ===
  
  - id: SUB-RES-002-A
    parent: TASK-RES-002
    title: Implement sign thresholding function
    agent: VSAExpert
    deps: [TASK-RES-001]
    scope: |
      Add to src/resonator.rs:
      - fn threshold_ternary(dense: &[f64]) -> SparseVec
      - Apply sign function: >ε → +1, <-ε → -1, else 0
      - Select top-k positive and negative indices for sparsity
    file: src/resonator.rs
    acceptance:
      - Output is valid sparse ternary
      - Sparsity is maintained
    estimate_minutes: 40
    
  - id: SUB-RES-003-A
    parent: TASK-RES-003
    title: Add resonator option to EmbrFS extract
    agent: RustEngineer
    deps: [TASK-RES-001, TASK-RES-002]
    scope: |
      Modify extraction path:
      - Add use_resonator: bool flag to extract options
      - When true, use resonator.factorize() for deep paths
      - Fall back to sequential unbind when false
    file: src/embrfs.rs
    acceptance:
      - Both paths produce identical output
      - Resonator handles deep hierarchies better
    estimate_minutes: 60
    
  - id: SUB-RES-003-B
    parent: TASK-RES-003
    title: Integration test for 20+ level hierarchy
    agent: RustEngineer
    deps: [SUB-RES-003-A]
    scope: |
      Create deep hierarchy test:
      - Generate 25-level nested directories
      - Encode with hierarchical mode
      - Extract with resonator enabled
      - Verify 100% bit-perfect reconstruction
    file: tests/integration_cli.rs
    acceptance:
      - All files reconstructed correctly
      - No cosine threshold failures
    estimate_minutes: 60

  # === WAVE 6: TASK-HIE-004, TASK-TEST-003 ===
  
  - id: SUB-HIE-004-A
    parent: TASK-HIE-004
    title: Implement manifest-guided level traversal
    agent: RustEngineer
    deps: [TASK-HIE-003, TASK-RES-003]
    scope: |
      Add hierarchical extraction:
      - Parse HierarchicalManifest levels
      - For each level, unbind path roles
      - Descend to child sub-engrams
      - Collect leaf chunks for reassembly
    file: src/embrfs.rs
    acceptance:
      - Traversal visits all levels
      - Correct sub-engrams loaded
    estimate_minutes: 90
    
  - id: SUB-HIE-004-B
    parent: TASK-HIE-004
    title: Implement hierarchical reassembly
    agent: RustEngineer
    deps: [SUB-HIE-004-A]
    scope: |
      Add file reassembly from hierarchical extract:
      - Collect chunks in manifest order
      - Lookup in codebook for data
      - Write to output directory
      - Verify checksums
    file: src/embrfs.rs
    acceptance:
      - Output matches input exactly
      - No missing chunks
    estimate_minutes: 60
    
  - id: SUB-HIE-004-C
    parent: TASK-HIE-004
    title: E2E hierarchical round-trip test
    agent: RustEngineer
    deps: [SUB-HIE-004-B]
    scope: |
      Create comprehensive E2E test:
      - Use realistic directory structure
      - Ingest with --hierarchical flag
      - Extract to new location
      - Compare with diff -r
    file: tests/e2e_regression.rs
    acceptance:
      - diff shows no differences
      - Test is reproducible
    estimate_minutes: 45

  - id: SUB-TEST-003-A
    parent: TASK-TEST-003
    title: Resonator convergence tests
    agent: Tester
    deps: [TASK-RES-003]
    scope: |
      Add tests/resonator_tests.rs:
      - test_factorize_two_factors(): verify 2-factor recovery
      - test_factorize_deep_compound(): 5+ factors
      - test_convergence_metrics(): iterations < max
    file: tests/resonator_tests.rs
    acceptance:
      - All tests pass
      - Convergence is reliable
    estimate_minutes: 45

  # === WAVE 7: TASK-PERF-001, TASK-TEST-002, TASK-FUSE-001 ===
  
  - id: SUB-PERF-001-A
    parent: TASK-PERF-001
    title: Add rayon dependency
    agent: RustEngineer
    deps: [TASK-HIE-004]
    scope: |
      Modify Cargo.toml:
      - Add rayon = "1.8" to dependencies
      - Import rayon::prelude::* in embrfs.rs
    files: [Cargo.toml, src/embrfs.rs]
    acceptance:
      - Compiles with rayon
    estimate_minutes: 10
    
  - id: SUB-PERF-001-B
    parent: TASK-PERF-001
    title: Parallelize chunk encoding
    agent: RustEngineer
    deps: [SUB-PERF-001-A]
    scope: |
      Modify ingest to use parallel iterators:
      - chunks.par_iter().map(encode_chunk)
      - Use thread-safe codebook updates
      - Benchmark improvement
    file: src/embrfs.rs
    acceptance:
      - Ingest is faster on multi-core
      - Output is identical
    estimate_minutes: 60

  - id: SUB-TEST-002-A
    parent: TASK-TEST-002
    title: Synthetic TB-scale dataset generator
    agent: Tester
    deps: [TASK-HIE-004]
    scope: |
      Create test utility:
      - fn generate_synthetic_tree(depth: usize, breadth: usize, file_size: usize)
      - Generate deterministic content for verification
      - Support configurable total size
    file: tests/e2e_hierarchical.rs
    acceptance:
      - Generates valid directory tree
      - Deterministic for test reproducibility
    estimate_minutes: 45

  - id: SUB-FUSE-001-A
    parent: TASK-FUSE-001
    title: Add fuser dependency and module
    agent: RustEngineer
    deps: [TASK-HIE-004, TASK-RES-003]
    scope: |
      Setup FUSE foundation:
      - Add fuser = "0.14" to Cargo.toml with feature flag
      - Create src/fuse.rs module
      - Define EmbrFuse struct
    files: [Cargo.toml, src/fuse.rs, src/lib.rs]
    acceptance:
      - Compiles with --features fuse
      - Module structure in place
    estimate_minutes: 30
    
  - id: SUB-FUSE-001-B
    parent: TASK-FUSE-001
    title: Implement FUSE read operations
    agent: RustEngineer
    deps: [SUB-FUSE-001-A]
    scope: |
      Implement fuser::Filesystem trait:
      - lookup(): compute path probe, find inode
      - getattr(): return file metadata from manifest
      - read(): unbind chunk, cleanup, return data
    file: src/fuse.rs
    acceptance:
      - Basic file reading works
      - ls and cat succeed
    estimate_minutes: 120
    
  - id: SUB-FUSE-001-C
    parent: TASK-FUSE-001
    title: Docker FUSE integration test
    agent: RustEngineer
    deps: [SUB-FUSE-001-B]
    scope: |
      Create integration test in Docker:
      - Mount engram in container
      - Read files via mount point
      - Compare with extracted files
      - Test POSIX parity
    file: tests/integration_fuse.rs
    acceptance:
      - Mount succeeds
      - Files readable
      - Content matches
    estimate_minutes: 60

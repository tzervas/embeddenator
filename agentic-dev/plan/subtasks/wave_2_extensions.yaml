# Atomic Subtask Definitions - Wave 2 (Extensions)
# Dependencies: Wave 1 must complete first

subtasks:
  # === TASK-VSA-002: Add permutation tagging for order encoding ===
  - id: SUB-VSA-002-A
    parent: TASK-VSA-002
    title: Implement permute() method
    agent: VSAExpert
    status: completed
    deps: [TASK-VSA-001]
    scope: |
      Add to impl SparseVec in src/vsa.rs:
      - fn permute(&self, shift: usize) -> SparseVec
      - Apply cyclic shift: new_idx = (idx + shift) % DIM
      - Sort resulting indices
      - Handle both pos and neg arrays
    file: src/vsa.rs
    insert_in: "impl SparseVec"
    acceptance:
      - permute(0) returns identical vector
      - permute(DIM) returns identical vector
      - Non-zero shift changes indices
    estimate_minutes: 30
    
  - id: SUB-VSA-002-B
    parent: TASK-VSA-002
    title: Implement inverse_permute() method
    agent: VSAExpert
    status: completed
    deps: [SUB-VSA-002-A]
    scope: |
      Add to impl SparseVec:
      - fn inverse_permute(&self, shift: usize) -> SparseVec
      - Apply reverse cyclic shift: new_idx = (idx + DIM - shift) % DIM
      - Verify: v.permute(k).inverse_permute(k) â‰ˆ v
    file: src/vsa.rs
    acceptance:
      - Round-trip preserves vector
      - Inverse is exact
    estimate_minutes: 20
    
  - id: SUB-VSA-002-C
    parent: TASK-VSA-002
    title: Add permutation tests
    agent: VSAExpert
    status: completed
    deps: [SUB-VSA-002-B]
    scope: |
      Add tests:
      - test_permute_identity(): shift=0 is no-op
      - test_permute_round_trip(): permute.inverse_permute recovers original
      - test_permute_orthogonality(): shifted vectors have low cosine with original
    file: tests/unit_tests.rs
    acceptance:
      - All tests pass
      - Orthogonality < 0.3 for shift > DIM/10
    estimate_minutes: 30

  # === TASK-VSA-003: Implement context-dependent thinning ===
  - id: SUB-VSA-003-A
    parent: TASK-VSA-003
    title: Design thinning algorithm
    agent: VSAExpert
    status: completed
    deps: [TASK-VSA-001]
    scope: |
      Document algorithm in code comments:
      - Input: SparseVec, target_density (f32)
      - Calculate current density from pos.len() + neg.len()
      - If current > target, randomly remove indices
      - Preserve ratio of pos/neg
    file: src/vsa.rs
    acceptance:
      - Algorithm documented
      - Edge cases identified
    estimate_minutes: 20
    
  - id: SUB-VSA-003-B
    parent: TASK-VSA-003
    title: Implement thin() method
    agent: VSAExpert
    status: completed
    deps: [SUB-VSA-003-A]
    scope: |
      Add to impl SparseVec:
      - fn thin(&self, target_non_zero: usize) -> SparseVec
      - If current count <= target, return clone
      - Otherwise, randomly sample to keep target indices
      - Maintain sorted order
    file: src/vsa.rs
    acceptance:
      - thin(200) on 400-element vector returns 200-element
      - thin(500) on 200-element vector returns 200-element (no change)
    estimate_minutes: 40
    
  - id: SUB-VSA-003-C
    parent: TASK-VSA-003
    title: Add thinning to bundle operation
    agent: VSAExpert
    status: completed
    deps: [SUB-VSA-003-B]
    scope: |
      Modify bundle() to optionally thin result:
      - Add optional config parameter or feature flag
      - After majority voting, thin to target if density > threshold
      - Default: thin to 200 non-zeros
    file: src/vsa.rs
    acceptance:
      - Bundling 100 vectors still returns ~200 non-zeros
      - Noise is controlled
    estimate_minutes: 30
    
  - id: SUB-VSA-003-D
    parent: TASK-VSA-003
    title: Property tests for sparsity invariants
    agent: VSAExpert
    deps: [SUB-VSA-003-C]
    scope: |
      Add proptest cases:
      - After N bundles, density remains bounded
      - Thinning preserves signal (cosine > threshold)
      - Thinning is deterministic with seed
    file: tests/properties.rs
    acceptance:
      - 1000+ cases pass
      - No density explosion
    estimate_minutes: 45

  # === TASK-HIE-002: Implement level-0 leaf encoding ===
  - id: SUB-HIE-002-A
    parent: TASK-HIE-002
    title: Add directory-level encoding function
    agent: RustEngineer
    deps: [TASK-HIE-001]
    scope: |
      Add to src/embrfs.rs:
      - fn encode_directory(path: &Path, max_chunks: usize) -> Result<SubEngram>
      - Chunk files, encode to vectors
      - Bundle up to max_chunks (default 1000)
      - Return SubEngram with root, manifest slice
    file: src/embrfs.rs
    acceptance:
      - Encodes directory of 500 files successfully
      - Errors if > max_chunks without splitting
    estimate_minutes: 60
    
  - id: SUB-HIE-002-B
    parent: TASK-HIE-002
    title: Implement sub-engram serialization
    agent: RustEngineer
    deps: [SUB-HIE-002-A]
    scope: |
      Add serialization for SubEngram:
      - fn serialize(&self) -> Vec<u8> (bincode)
      - fn deserialize(data: &[u8]) -> Result<Self>
      - Store sub-engrams separately from root
    file: src/embrfs.rs
    acceptance:
      - Round-trip serialization works
      - File size < original directory
    estimate_minutes: 30
    
  - id: SUB-HIE-002-C
    parent: TASK-HIE-002
    title: Add leaf encoding tests
    agent: RustEngineer
    deps: [SUB-HIE-002-B]
    scope: |
      Add integration tests:
      - test_encode_small_directory(): < 100 files
      - test_encode_at_limit(): exactly 1000 chunks
      - test_encode_over_limit(): > 1000 chunks returns error
    file: tests/integration_cli.rs
    acceptance:
      - All tests pass
      - Error messages are clear
    estimate_minutes: 30

  # === TASK-PERF-002: Implement SIMD cosine similarity ===
  - id: SUB-PERF-002-A
    parent: TASK-PERF-002
    title: Add SIMD feature flag to Cargo.toml
    agent: RustEngineer
    deps: [TASK-VSA-001]
    scope: |
      Modify Cargo.toml:
      - Add [features] section if not exists
      - simd = []
      - Add conditional compilation cfg attributes
    file: Cargo.toml
    acceptance:
      - cargo build --features simd compiles
      - cargo build without flag compiles
    estimate_minutes: 15
    
  - id: SUB-PERF-002-B
    parent: TASK-PERF-002
    title: Implement SIMD dot product
    agent: RustEngineer
    deps: [SUB-PERF-002-A]
    scope: |
      Add #[cfg(feature = "simd")] version of cosine():
      - Use std::arch intrinsics or portable_simd
      - Vectorize dot product computation
      - Maintain fallback for non-SIMD
    file: src/vsa.rs
    acceptance:
      - SIMD version produces identical results
      - Benchmark shows improvement
    estimate_minutes: 90
    
  - id: SUB-PERF-002-C
    parent: TASK-PERF-002
    title: Add SIMD benchmarks
    agent: RustEngineer
    deps: [SUB-PERF-002-B]
    scope: |
      Create benches/vsa_bench.rs:
      - Benchmark cosine with/without SIMD
      - Benchmark bundle operation
      - Compare 10K vs 100K dimensions
    file: benches/vsa_bench.rs
    crate_dep: criterion
    acceptance:
      - cargo bench runs
      - HTML report generated
      - SIMD shows measurable improvement
    estimate_minutes: 45

  # === TASK-CI-002: Enable ARM64 auto-trigger ===
  - id: SUB-CI-002-A
    parent: TASK-CI-002
    title: Update ci-arm64.yml trigger config
    agent: DockerDevOps
    deps: [TASK-CI-001]
    scope: |
      Modify .github/workflows/ci-arm64.yml:
      - Add push: branches: [main] trigger
      - Keep workflow_dispatch for manual runs
      - Add comment explaining main-only strategy
    file: .github/workflows/ci-arm64.yml
    acceptance:
      - YAML is valid
      - Trigger config is correct
    estimate_minutes: 10
    
  - id: SUB-CI-002-B
    parent: TASK-CI-002
    title: Verify first auto-triggered run
    agent: DockerDevOps
    deps: [SUB-CI-002-A]
    scope: |
      Push change to main and verify:
      - Workflow triggers automatically
      - All tests pass
      - Artifacts are generated
    acceptance:
      - Automatic run succeeds
      - No manual intervention needed
    estimate_minutes: 20

# Atomic Subtask Definitions - Wave 1 (Foundation)
# Execution Order: These can run in parallel as they have no dependencies

subtasks:
  # === TASK-VSA-001: Implement VSAConfig adaptive sparsity ===
  - id: SUB-VSA-001-A
    parent: TASK-VSA-001
    title: Add VSAConfig struct to vsa.rs
    agent: RustEngineer
    scope: |
      Add VSAConfig struct after DIM constant in src/vsa.rs:
      - Fields: dimensionality (usize), target_non_zero (usize), sparsity (f32)
      - Derive: Clone, Debug, Serialize, Deserialize
    file: src/vsa.rs
    insert_after_line: 15
    acceptance:
      - VSAConfig struct compiles
      - Fields have correct types
    estimate_minutes: 30
    
  - id: SUB-VSA-001-B
    parent: TASK-VSA-001
    title: Implement VSAConfig::new() constructor
    agent: RustEngineer
    deps: [SUB-VSA-001-A]
    scope: |
      Implement VSAConfig::new(dimensionality: usize) -> Self:
      - Set target_non_zero = 200 (constant)
      - Calculate sparsity = target_non_zero as f32 / dimensionality as f32
      - Return populated struct
    file: src/vsa.rs
    acceptance:
      - new(10000) returns sparsity = 0.02
      - new(100000) returns sparsity = 0.002
    estimate_minutes: 20
    
  - id: SUB-VSA-001-C
    parent: TASK-VSA-001
    title: Add preset constructors
    agent: RustEngineer
    deps: [SUB-VSA-001-B]
    scope: |
      Add preset methods:
      - fn high_precision() -> Self { Self::new(100_000) }
      - fn balanced() -> Self { Self::new(50_000) }
      - fn fast() -> Self { Self::new(10_000) }
    file: src/vsa.rs
    acceptance:
      - All three presets return correct dimensionality
      - Sparsity values match formula
    estimate_minutes: 15
    
  - id: SUB-VSA-001-D
    parent: TASK-VSA-001
    title: Add unit tests for VSAConfig
    agent: RustEngineer
    deps: [SUB-VSA-001-C]
    scope: |
      Add tests in tests/unit_tests.rs:
      - test_vsaconfig_new(): verify formula
      - test_vsaconfig_presets(): verify preset values
      - test_vsaconfig_serialization(): round-trip serde
    file: tests/unit_tests.rs
    acceptance:
      - All tests pass
      - cargo test --lib shows green
    estimate_minutes: 30
    
  - id: SUB-VSA-001-E
    parent: TASK-VSA-001
    title: Export VSAConfig from lib.rs
    agent: RustEngineer
    deps: [SUB-VSA-001-A]
    scope: |
      Add to src/lib.rs exports:
      - pub use vsa::VSAConfig;
    file: src/lib.rs
    acceptance:
      - use embeddenator::VSAConfig compiles
    estimate_minutes: 5

  # === TASK-HIE-001: Design nested manifest format ===
  - id: SUB-HIE-001-A
    parent: TASK-HIE-001
    title: Create HierarchicalManifest struct
    agent: RustEngineer
    scope: |
      Add to src/embrfs.rs:
      - HierarchicalManifest { version: u32, levels: Vec<ManifestLevel>, sub_engrams: HashMap<String, SubEngram> }
      - ManifestLevel { level: u32, items: Vec<ManifestItem> }
      - SubEngram { id: String, root_hash: String, chunk_count: usize, children: Vec<String> }
    file: src/embrfs.rs
    acceptance:
      - Structs compile with serde derives
    estimate_minutes: 45
    
  - id: SUB-HIE-001-B
    parent: TASK-HIE-001
    title: Design backward-compatible manifest enum
    agent: RustEngineer
    deps: [SUB-HIE-001-A]
    scope: |
      Create enum to support both formats:
      - Manifest { Flat(FlatManifest), Hierarchical(HierarchicalManifest) }
      - Implement From<FlatManifest> for Manifest
      - Ensure existing engrams deserialize correctly
    file: src/embrfs.rs
    acceptance:
      - Old engrams load without error
      - New engrams use hierarchical format
    estimate_minutes: 40
    
  - id: SUB-HIE-001-C
    parent: TASK-HIE-001
    title: Write HIERARCHICAL_FORMAT.md design doc
    agent: RustEngineer
    scope: |
      Create docs/HIERARCHICAL_FORMAT.md with:
      - JSON schema for nested manifest
      - Examples for 3-level hierarchy
      - Migration path from flat format
      - Size limits per level (1000 items)
    file: docs/HIERARCHICAL_FORMAT.md
    acceptance:
      - Document covers all use cases
      - JSON examples are valid
    estimate_minutes: 60

  # === TASK-CI-001: ARM64 runner deployment ===
  - id: SUB-CI-001-A
    parent: TASK-CI-001
    title: Verify ARM64 runner prerequisites
    agent: DockerDevOps
    scope: |
      Check .github/workflows/ARM64_RUNNER_SETUP.md:
      - Confirm hardware requirements are met
      - Validate runner registration command
      - Ensure labels match ci-arm64.yml
    file: .github/workflows/ARM64_RUNNER_SETUP.md
    acceptance:
      - Prerequisites checklist passes
    estimate_minutes: 30
    
  - id: SUB-CI-001-B
    parent: TASK-CI-001
    title: Deploy ARM64 self-hosted runner
    agent: DockerDevOps
    deps: [SUB-CI-001-A]
    scope: |
      Execute runner deployment:
      - Download GitHub Actions runner
      - Configure with correct labels: [self-hosted, Linux, ARM64]
      - Start runner service
      - Verify visible in GitHub Settings
    acceptance:
      - Runner shows "Idle" in GitHub
      - Labels match workflow requirements
    estimate_minutes: 60
    
  - id: SUB-CI-001-C
    parent: TASK-CI-001
    title: Trigger manual ARM64 workflow
    agent: DockerDevOps
    deps: [SUB-CI-001-B]
    scope: |
      Run .github/workflows/ci-arm64.yml:
      - Trigger via workflow_dispatch
      - Monitor execution
      - Collect test results
    file: .github/workflows/ci-arm64.yml
    acceptance:
      - Workflow completes successfully
      - All 33 tests pass
    estimate_minutes: 45
    
  - id: SUB-CI-001-D
    parent: TASK-CI-001
    title: Document ARM64 test results
    agent: DockerDevOps
    deps: [SUB-CI-001-C]
    scope: |
      Create docs/ARM64_TEST_RESULTS.md:
      - Test summary (passed/failed/skipped)
      - Performance metrics vs amd64
      - Known limitations
      - Recommendations
    file: docs/ARM64_TEST_RESULTS.md
    acceptance:
      - Document is comprehensive
      - Results are accurate
    estimate_minutes: 30
